<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
    <meta name="theme-color" content="#1e1f20">
    <title>{{title | capitalize}} - {{site.my_name}}</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="/css/wedding.css">
    <!-- Preload SoundCloud API as early as possible -->
    <script async src="https://w.soundcloud.com/player/api.js"></script>

    <meta property="og:title" content="{{title}}" />
    <meta property="og:type" content="article" />
    <meta property="og:description" content="{{blurb}}" />
    <meta property="og:image" content="{{site.url}}{{image}}" />
    <meta property="og:url" content="{{site.url}}{{ page.url }}" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@lynchyeatspizza">
    <meta name="twitter:title" content="{{title}}">
    <meta name="twitter:description" content="{{blurb}}">
    <meta name="twitter:image" content="{{site.url}}{{image}}">

    {% if published==false %}
    <meta name="robots" content="noindex, follow">
    {% endif %}

    {% if env.isProd %}
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-179723365-1"></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-179723365-1');
    </script>
    {% endif %}

  </head>
  <body class="wedding-page">
    {{ content }}

    <script>
    {% include js/wedding-personalization.js %}

    // Calendar dropdown toggle
    function toggleCalendarMenu(event) {
      event.stopPropagation();
      const calMenu = document.getElementById('calendarMenu');
      const rsvpMenu = document.getElementById('rsvpMenu');

      // Close RSVP menu if open
      if (rsvpMenu) rsvpMenu.classList.remove('show');

      calMenu.classList.toggle('show');
    }

    // RSVP dropdown toggle
    function toggleRsvpMenu(event) {
      event.stopPropagation();
      const calMenu = document.getElementById('calendarMenu');
      const rsvpMenu = document.getElementById('rsvpMenu');

      // Close calendar menu if open
      if (calMenu) calMenu.classList.remove('show');

      rsvpMenu.classList.toggle('show');
    }

    // Open RSVP email in different clients
    function openRsvpEmail(clientType) {
      const recipientEmail = "rsvp@millaandtom.com"; // Change this to your RSVP email
      const emailSubject = "RSVP - Milla & Tom's Wedding";
      const emailBody = `Hi Milla & Tom,

I'm writing to RSVP for your wedding on Saturday, November 28th, 2026.

[Please share your response below]

Attending: Yes / No / Maybe
Number of guests:
Dietary requirements:
Song requests:

Looking forward to celebrating with you!

Best regards,
[Your Name]`;

      // URL encode the parameters
      const encodedSubject = encodeURIComponent(emailSubject);
      const encodedBody = encodeURIComponent(emailBody);
      const encodedTo = encodeURIComponent(recipientEmail);

      let emailUrl;
      switch(clientType) {
        case 'gmail':
          emailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodedTo}&su=${encodedSubject}&body=${encodedBody}`;
          break;
        case 'outlook':
          emailUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodedTo}&subject=${encodedSubject}&body=${encodedBody}`;
          break;
        case 'yahoo':
          emailUrl = `https://compose.mail.yahoo.com/?to=${encodedTo}&subject=${encodedSubject}&body=${encodedBody}`;
          break;
        case 'default':
        default:
          emailUrl = `mailto:${encodedTo}?subject=${encodedSubject}&body=${encodedBody}`;
          break;
      }

      // Open the email client
      window.open(emailUrl, '_blank');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      const calMenu = document.getElementById('calendarMenu');
      const rsvpMenu = document.getElementById('rsvpMenu');

      if (calMenu && calMenu.classList.contains('show')) {
        calMenu.classList.remove('show');
      }
      if (rsvpMenu && rsvpMenu.classList.contains('show')) {
        rsvpMenu.classList.remove('show');
      }
    });

    // === Let's Go Button: Music + Autoscroll ===
    let scWidget = null;
    let isReady = false;
    let isPlaying = false;
    let isScrolling = false;
    let hasStartedScroll = false;
    let scrollAnimationId = null;
    let wakeLock = null;
    const SCROLL_SPEED = 1.5;
    const SCROLL_DELAY = 1500; // ms after music starts

    // Wake lock to keep screen on
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
      }
    }
    function releaseWakeLock() {
      if (wakeLock) { wakeLock.release(); wakeLock = null; }
    }

    // Update button appearance
    function updateButton(state) {
      const btn = document.getElementById('letsGoBtn');
      const speakerIcon = btn.querySelector('.speaker-icon');
      const pauseIcon = btn.querySelector('.pause-icon');
      const label = btn.querySelector('.btn-label');
      const equalizer = document.getElementById('equalizer');

      if (state === 'loading') {
        label.textContent = '...';
        btn.classList.remove('active');
        speakerIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        equalizer.classList.remove('playing');
      } else if (state === 'playing') {
        label.textContent = 'Stop';
        btn.classList.add('active');
        speakerIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
        equalizer.classList.add('playing');
      } else {
        label.textContent = "Let's go";
        btn.classList.remove('active');
        speakerIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        equalizer.classList.remove('playing');
      }
    }

    // Initialize SoundCloud widget on page load
    function initSoundCloudWidget() {
      const iframe = document.getElementById('soundcloudPlayer');
      if (!iframe || !window.SC) return;

      scWidget = SC.Widget(iframe);

      // Widget is ready (song preloaded)
      scWidget.bind(SC.Widget.Events.READY, function() {
        isReady = true;
        // If user clicked while still loading, try to play now
        if (isPlaying && !hasStartedScroll) {
          scWidget.setVolume(100);
          scWidget.play();
        }
      });

      // Music actually playing - update button and start scroll
      scWidget.bind(SC.Widget.Events.PLAY, function() {
        if (isPlaying && !hasStartedScroll) {
          hasStartedScroll = true;
          updateButton('playing');
          setTimeout(function() {
            if (isPlaying) {
              isScrolling = true;
              autoScroll();
            }
          }, SCROLL_DELAY);
        }
      });

      // Song ended or paused
      scWidget.bind(SC.Widget.Events.FINISH, function() {
        stopExperience();
      });

      scWidget.bind(SC.Widget.Events.PAUSE, function() {
        // Browser auto-paused (mobile autoplay policy)
        // Reset state and prompt user to tap again
        if (isPlaying) {
          isPlaying = false;
          isScrolling = false;
          hasStartedScroll = false;
          if (scrollAnimationId) {
            cancelAnimationFrame(scrollAnimationId);
            scrollAnimationId = null;
          }
          releaseWakeLock();
          // Show "Tap again" instead of "Let's go" so user knows to try again
          const btn = document.getElementById('letsGoBtn');
          const label = btn.querySelector('.btn-label');
          const speakerIcon = btn.querySelector('.speaker-icon');
          const pauseIcon = btn.querySelector('.pause-icon');
          const equalizer = document.getElementById('equalizer');
          btn.classList.remove('active');
          speakerIcon.style.display = 'block';
          pauseIcon.style.display = 'none';
          equalizer.classList.remove('playing');
          label.textContent = "oops, let's go again";
        }
      });
    }

    // Start everything
    function startExperience() {
      isPlaying = true;
      hasStartedScroll = false;
      requestWakeLock();

      // Always show loading first - only show "playing" when music actually starts
      updateButton('loading');

      if (isReady && scWidget) {
        // Ensure volume is up and play
        scWidget.setVolume(100);
        scWidget.play();
      }
      // If not ready, loading state stays until READY event
    }

    // Stop everything
    function stopExperience() {
      isPlaying = false;
      isScrolling = false;
      hasStartedScroll = false;
      if (scrollAnimationId) {
        cancelAnimationFrame(scrollAnimationId);
        scrollAnimationId = null;
      }
      if (scWidget) scWidget.pause();
      updateButton('stopped');
      releaseWakeLock();
    }

    // Stop just scrolling (user scrolled manually)
    function stopScrollingOnly() {
      isScrolling = false;
      if (scrollAnimationId) {
        cancelAnimationFrame(scrollAnimationId);
        scrollAnimationId = null;
      }
    }

    // Button click handler
    function toggleExperience() {
      if (isPlaying) {
        stopExperience();
      } else {
        startExperience();
      }
    }

    // Smooth autoscroll
    function autoScroll() {
      if (!isScrolling) return;
      const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
      if (window.scrollY < maxScroll) {
        window.scrollBy(0, SCROLL_SPEED);
        scrollAnimationId = requestAnimationFrame(autoScroll);
      } else {
        stopScrollingOnly();
      }
    }

    // Initialize widget as soon as SoundCloud API is ready
    // (API script loads in <head> for earliest possible start)
    (function tryInit() {
      if (window.SC) {
        initSoundCloudWidget();
      } else {
        setTimeout(tryInit, 50);
      }
    })();

    // Stop autoscroll (but not music) if user manually scrolls
    window.addEventListener('wheel', function() {
      if (isScrolling) {
        stopScrollingOnly();
      }
    }, { passive: true });

    window.addEventListener('touchmove', function() {
      if (isScrolling) {
        stopScrollingOnly();
      }
    }, { passive: true });
    </script>
  </body>
</html>
