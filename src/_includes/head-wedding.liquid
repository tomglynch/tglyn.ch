<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
    <meta name="theme-color" content="#1e1f20">
    <title>{{title | capitalize}} - {{site.my_name}}</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="/css/wedding.css">

    <meta property="og:title" content="{{title}}" />
    <meta property="og:type" content="article" />
    <meta property="og:description" content="{{blurb}}" />
    <meta property="og:image" content="{{site.url}}{{image}}" />
    <meta property="og:url" content="{{site.url}}{{ page.url }}" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@lynchyeatspizza">
    <meta name="twitter:title" content="{{title}}">
    <meta name="twitter:description" content="{{blurb}}">
    <meta name="twitter:image" content="{{site.url}}{{image}}">

    {% if published==false %}
    <meta name="robots" content="noindex, follow">
    {% endif %}

    {% if env.isProd %}
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-179723365-1"></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-179723365-1');
    </script>
    {% endif %}

  </head>
  <body class="wedding-page">
    {{ content }}

    <script>
    {% include js/wedding-personalization.js %}

    // Calendar dropdown toggle
    function toggleCalendarMenu(event) {
      event.stopPropagation();
      const calMenu = document.getElementById('calendarMenu');
      const rsvpMenu = document.getElementById('rsvpMenu');

      // Close RSVP menu if open
      if (rsvpMenu) rsvpMenu.classList.remove('show');

      calMenu.classList.toggle('show');
    }

    // RSVP dropdown toggle
    function toggleRsvpMenu(event) {
      event.stopPropagation();
      const calMenu = document.getElementById('calendarMenu');
      const rsvpMenu = document.getElementById('rsvpMenu');

      // Close calendar menu if open
      if (calMenu) calMenu.classList.remove('show');

      rsvpMenu.classList.toggle('show');
    }

    // Open RSVP email in different clients
    function openRsvpEmail(clientType) {
      const recipientEmail = "rsvp@millaandtom.com"; // Change this to your RSVP email
      const emailSubject = "RSVP - Milla & Tom's Wedding";
      const emailBody = `Hi Milla & Tom,

I'm writing to RSVP for your wedding on Saturday, November 28th, 2026.

[Please share your response below]

Attending: Yes / No / Maybe
Number of guests:
Dietary requirements:
Song requests:

Looking forward to celebrating with you!

Best regards,
[Your Name]`;

      // URL encode the parameters
      const encodedSubject = encodeURIComponent(emailSubject);
      const encodedBody = encodeURIComponent(emailBody);
      const encodedTo = encodeURIComponent(recipientEmail);

      let emailUrl;
      switch(clientType) {
        case 'gmail':
          emailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodedTo}&su=${encodedSubject}&body=${encodedBody}`;
          break;
        case 'outlook':
          emailUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodedTo}&subject=${encodedSubject}&body=${encodedBody}`;
          break;
        case 'yahoo':
          emailUrl = `https://compose.mail.yahoo.com/?to=${encodedTo}&subject=${encodedSubject}&body=${encodedBody}`;
          break;
        case 'default':
        default:
          emailUrl = `mailto:${encodedTo}?subject=${encodedSubject}&body=${encodedBody}`;
          break;
      }

      // Open the email client
      window.open(emailUrl, '_blank');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      const calMenu = document.getElementById('calendarMenu');
      const rsvpMenu = document.getElementById('rsvpMenu');

      if (calMenu && calMenu.classList.contains('show')) {
        calMenu.classList.remove('show');
      }
      if (rsvpMenu && rsvpMenu.classList.contains('show')) {
        rsvpMenu.classList.remove('show');
      }
    });

    // Combined Experience: Music + Autoscroll
    let scWidget = null;
    let widgetReady = false;
    let experienceActive = false;
    let isScrolling = false;
    let scrollTimerStarted = false;
    let scrollAnimationId = null;
    const scrollSpeed = 1.5; // pixels per frame (~90px per second at 60fps)

    // Initialize SoundCloud Widget when API is ready
    function initSoundCloudWidget() {
      const iframe = document.getElementById('soundcloudPlayer');
      if (iframe && window.SC) {
        scWidget = SC.Widget(iframe);

        scWidget.bind(SC.Widget.Events.READY, function() {
          widgetReady = true;
          // If user clicked before ready, start music now
          if (experienceActive) {
            startMusic();
          }
        });

        // Detect when music actually starts playing (audio is progressing)
        scWidget.bind(SC.Widget.Events.PLAY_PROGRESS, function(data) {
          // Only trigger once when we first detect audio is actually playing
          if (experienceActive && !scrollTimerStarted && data.currentPosition > 0) {
            scrollTimerStarted = true;
            updateButtonState(true);
            // Wait 0.75 seconds after music actually starts before scrolling
            setTimeout(function() {
              if (experienceActive && !isScrolling) {
                isScrolling = true;
                autoScroll();
              }
            }, 1500);
          }
        });

        scWidget.bind(SC.Widget.Events.FINISH, function() {
          // Song ended, stop the experience
          stopExperience();
        });
      }
    }

    function startMusic() {
      // Seek to beginning and play to ensure consistent timing
      scWidget.seekTo(0);
      scWidget.play();
    }

    function updateButtonState(active) {
      const btn = document.getElementById('letsGoBtn');
      const speakerIcon = btn.querySelector('.speaker-icon');
      const pauseIcon = btn.querySelector('.pause-icon');
      const label = btn.querySelector('.btn-label');
      const equalizer = document.getElementById('equalizer');

      if (active) {
        btn.classList.add('active');
        speakerIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
        label.textContent = 'Stop';
        equalizer.classList.add('playing');
      } else {
        btn.classList.remove('active');
        speakerIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        label.textContent = "Let's go";
        equalizer.classList.remove('playing');
      }
    }

    function stopScrollingOnly() {
      // Stop scrolling but keep music playing
      isScrolling = false;
      if (scrollAnimationId) {
        cancelAnimationFrame(scrollAnimationId);
        scrollAnimationId = null;
      }
    }

    function stopExperience() {
      experienceActive = false;
      scrollTimerStarted = false;
      // Stop music
      if (scWidget) {
        scWidget.pause();
      }
      // Stop scrolling
      stopScrollingOnly();
      updateButtonState(false);
    }

    function toggleExperience() {
      if (experienceActive) {
        stopExperience();
      } else {
        experienceActive = true;
        scrollTimerStarted = false;
        if (widgetReady) {
          // Widget preloaded and ready, seek to start and play
          startMusic();
        } else {
          // Widget not ready yet, show loading state
          const label = document.querySelector('.btn-label');
          if (label) label.textContent = 'Loading...';
        }
      }
    }

    function autoScroll() {
      if (!isScrolling) return;

      const maxScroll = document.documentElement.scrollHeight - window.innerHeight;

      if (window.scrollY < maxScroll) {
        window.scrollBy(0, scrollSpeed);
        scrollAnimationId = requestAnimationFrame(autoScroll);
      } else {
        // Reached the bottom, stop scrolling but keep music playing
        stopScrollingOnly();
      }
    }

    // Load and preload SoundCloud Widget API on page load
    (function() {
      const script = document.createElement('script');
      script.src = 'https://w.soundcloud.com/player/api.js';
      script.onload = initSoundCloudWidget;
      document.head.appendChild(script);
    })();

    // Stop autoscroll (but not music) if user manually scrolls
    window.addEventListener('wheel', function() {
      if (isScrolling) {
        stopScrollingOnly();
      }
    }, { passive: true });

    window.addEventListener('touchmove', function() {
      if (isScrolling) {
        stopScrollingOnly();
      }
    }, { passive: true });
    </script>
  </body>
</html>
