<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
    <meta name="theme-color" content="#1e1f20">
    <title>{{title | capitalize}} - {{site.my_name}}</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="/css/wedding.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <meta property="og:title" content="{{title}}" />
    <meta property="og:type" content="article" />
    <meta property="og:description" content="{{blurb}}" />
    <meta property="og:image" content="{{site.url}}{{image}}" />
    <meta property="og:url" content="{{site.url}}{{ page.url }}" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@lynchyeatspizza">
    <meta name="twitter:title" content="{{title}}">
    <meta name="twitter:description" content="{{blurb}}">
    <meta name="twitter:image" content="{{site.url}}{{image}}">

    {% if published==false %}
    <meta name="robots" content="noindex, follow">
    {% endif %}

    {% if env.isProd %}
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-179723365-1"></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-179723365-1');
    </script>
    {% endif %}

  </head>
  <body class="wedding-page">
    {{ content }}

    <script>
    {% include js/wedding-personalization.js %}

    // Calendar dropdown toggle
    function toggleCalendarMenu(event) {
      event.stopPropagation();
      const calMenu = document.getElementById('calendarMenu');
      const rsvpMenu = document.getElementById('rsvpMenu');

      // Close RSVP menu if open
      if (rsvpMenu) rsvpMenu.classList.remove('show');

      calMenu.classList.toggle('show');
    }

    // RSVP dropdown toggle
    function toggleRsvpMenu(event) {
      event.stopPropagation();
      const calMenu = document.getElementById('calendarMenu');
      const rsvpMenu = document.getElementById('rsvpMenu');

      // Close calendar menu if open
      if (calMenu) calMenu.classList.remove('show');

      rsvpMenu.classList.toggle('show');
    }

    // Open RSVP email in different clients
    function openRsvpEmail(clientType) {
      const recipientEmail = "rsvp@millaandtom.com"; // Change this to your RSVP email
      const emailSubject = "RSVP - Milla & Tom's Wedding";
      const emailBody = `Hi Milla & Tom,

I'm writing to RSVP for your wedding on Saturday, November 28th, 2026.

[Please share your response below]

Attending: Yes / No / Maybe
Number of guests:
Dietary requirements:
Song requests:

Looking forward to celebrating with you!

Best regards,
[Your Name]`;

      // URL encode the parameters
      const encodedSubject = encodeURIComponent(emailSubject);
      const encodedBody = encodeURIComponent(emailBody);
      const encodedTo = encodeURIComponent(recipientEmail);

      let emailUrl;
      switch(clientType) {
        case 'gmail':
          emailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodedTo}&su=${encodedSubject}&body=${encodedBody}`;
          break;
        case 'outlook':
          emailUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodedTo}&subject=${encodedSubject}&body=${encodedBody}`;
          break;
        case 'yahoo':
          emailUrl = `https://compose.mail.yahoo.com/?to=${encodedTo}&subject=${encodedSubject}&body=${encodedBody}`;
          break;
        case 'default':
        default:
          emailUrl = `mailto:${encodedTo}?subject=${encodedSubject}&body=${encodedBody}`;
          break;
      }

      // Open the email client
      window.open(emailUrl, '_blank');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      const calMenu = document.getElementById('calendarMenu');
      const rsvpMenu = document.getElementById('rsvpMenu');

      if (calMenu && calMenu.classList.contains('show')) {
        calMenu.classList.remove('show');
      }
      if (rsvpMenu && rsvpMenu.classList.contains('show')) {
        rsvpMenu.classList.remove('show');
      }
    });

    // === Let's Go Button: Music + Autoscroll ===
    const playlist = [
      'audio/praise-you-mix.mp3',
      'audio/astounded.mp3',
      'audio/where-is-hubby.mp3',
      'audio/the-bug-club-marriage.mp3'
    ];
    let currentTrack = 0;
    let audioPlayer = null;
    let isPlaying = false;
    let isScrolling = false;
    let scrollAnimationId = null;
    let scrollDelayId = null;
    let wakeLock = null;
    let wasAtBottom = false;
    const SCROLL_DURATION = 50000; // 50 seconds
    const SCROLL_DELAY = 1000; // ms after music starts
    let scrollStartTime = null;
    let scrollStartY = 0; // Y position when scroll started

    // Confetti when reaching bottom
    let confettiCanvas = null;
    let myConfetti = null;

    function showConfetti() {
      if (typeof confetti !== 'function') return;

      // Create canvas if it doesn't exist
      if (!confettiCanvas) {
        confettiCanvas = document.createElement('canvas');
        confettiCanvas.style.position = 'fixed';
        confettiCanvas.style.top = '0';
        confettiCanvas.style.left = '0';
        confettiCanvas.style.width = '100vw';
        confettiCanvas.style.height = '100vh';
        confettiCanvas.style.pointerEvents = 'none';
        confettiCanvas.style.zIndex = '99999';
        document.body.appendChild(confettiCanvas);
        myConfetti = confetti.create(confettiCanvas, { resize: true });
      }

      // Fire bursts for 1 second, with long-lasting particles
      var duration = 1000;
      var end = Date.now() + duration;
      var frameCount = 0;

      (function frame() {
        frameCount++;
        // Only fire every 5th frame to avoid heaps at once
        if (frameCount % 5 === 0) {
          myConfetti({
            particleCount: 20,
            angle: 60,
            spread: 55,
            origin: { x: 0, y: 0.6 },
            colors: ['#c68601', '#a95100ff', '#c1c1c1ff', '#ccff00ff', '#e3a807'],  
            ticks: 400,
            gravity: 0.6,
            decay: 0.94
          });
          myConfetti({
            particleCount: 20,
            angle: 120,
            spread: 55,
            origin: { x: 1, y: 0.6 },
            colors: ['#c68601', '#a95100ff', '#c1c1c1ff', '#ccff00ff', '#e3a807'],
            ticks: 400,
            gravity: 0.6,
            decay: 0.94
          });
        }

        if (Date.now() < end) {
          requestAnimationFrame(frame);
        }
      }());
    }

    function isAtBottom() {
      return (window.innerHeight + window.scrollY) >= (document.documentElement.scrollHeight - 10);
    }

    // Wake lock to keep screen on
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
      }
    }
    function releaseWakeLock() {
      if (wakeLock) { wakeLock.release(); wakeLock = null; }
    }

    // Update button appearance
    function updateButton(state) {
      const btn = document.getElementById('letsGoBtn');
      const speakerIcon = btn.querySelector('.speaker-icon');
      const stopIcon = btn.querySelector('.stop-icon');
      const label = btn.querySelector('.btn-label');
      const equalizer = document.getElementById('equalizer');

      if (state === 'playing') {
        label.textContent = 'Stop';
        btn.classList.add('active');
        speakerIcon.style.display = 'none';
        stopIcon.style.display = 'block';
        equalizer.classList.add('playing');
      } else {
        label.textContent = "Let's go";
        btn.classList.remove('active');
        speakerIcon.style.display = 'block';
        stopIcon.style.display = 'none';
        equalizer.classList.remove('playing');
      }
    }

    // Initialize audio player
    function initAudioPlayer() {
      audioPlayer = document.getElementById('audioPlayer');
      if (!audioPlayer) return;

      // Song ended - play next or stop if playlist done
      audioPlayer.addEventListener('ended', function() {
        currentTrack++;
        if (currentTrack < playlist.length) {
          audioPlayer.src = playlist[currentTrack];
          audioPlayer.play();
        } else {
          stopExperience();
        }
      });
    }

    // Start everything
    function startExperience() {
      if (!audioPlayer) return;

      audioPlayer.play().then(function() {
        isPlaying = true;
        requestWakeLock();
        updateButton('playing');

        // Start scrolling after delay
        scrollDelayId = setTimeout(function() {
          if (isPlaying) {
            isScrolling = true;
            scrollAnimationId = requestAnimationFrame(autoScroll);
          }
        }, SCROLL_DELAY);
      }).catch(function(err) {
        console.log('Audio play failed:', err);
      });
    }

    // Stop everything
    function stopExperience() {
      isPlaying = false;
      isScrolling = false;
      if (scrollDelayId) {
        clearTimeout(scrollDelayId);
        scrollDelayId = null;
      }
      if (scrollAnimationId) {
        cancelAnimationFrame(scrollAnimationId);
        scrollAnimationId = null;
      }
      if (audioPlayer) {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        // Reset to first track
        currentTrack = 0;
        audioPlayer.src = playlist[0];
      }
      updateButton('stopped');
      releaseWakeLock();
    }

    // Stop just scrolling (user scrolled manually)
    function stopScrollingOnly() {
      isScrolling = false;
      scrollStartTime = null;
      scrollStartY = 0;
      if (scrollAnimationId) {
        cancelAnimationFrame(scrollAnimationId);
        scrollAnimationId = null;
      }
    }

    // Button click handler
    function toggleExperience() {
      if (isPlaying) {
        stopExperience();
      } else {
        startExperience();
      }
    }

    // Smooth autoscroll (percentage-based for consistent timing across all devices)
    function autoScroll(timestamp) {
      if (!isScrolling) return;

      // Initialize on first frame
      if (!scrollStartTime) {
        scrollStartTime = timestamp;
        scrollStartY = window.scrollY;
      }

      const elapsed = timestamp - scrollStartTime;
      const progress = Math.min(elapsed / SCROLL_DURATION, 1);

      // Calculate target based on CURRENT page height (adapts to lazy loading/parallax)
      const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
      const targetY = scrollStartY + (progress * (maxScroll - scrollStartY));

      window.scrollTo(0, targetY);

      if (progress < 1) {
        scrollAnimationId = requestAnimationFrame(autoScroll);
      } else {
        stopScrollingOnly();
        showConfetti();
      }
    }

    // Initialize on page load
    initAudioPlayer();

    // Stop autoscroll (but not music) if user manually scrolls
    // Use a threshold to avoid accidental stops from minor movements
    let lastScrollY = window.scrollY;

    window.addEventListener('wheel', function(e) {
      if (isScrolling && Math.abs(e.deltaY) > 10) {
        stopScrollingOnly();
      }
    }, { passive: true });

    window.addEventListener('touchstart', function() {
      lastScrollY = window.scrollY;
    }, { passive: true });

    window.addEventListener('touchmove', function() {
      if (isScrolling && Math.abs(window.scrollY - lastScrollY) > 20) {
        stopScrollingOnly();
      }
    }, { passive: true });

    // Trigger confetti on manual scroll to bottom (only when newly arriving)
    window.addEventListener('scroll', function() {
      var atBottom = isAtBottom();
      if (atBottom && !wasAtBottom) {
        showConfetti();
      }
      wasAtBottom = atBottom;
    }, { passive: true });

    // Handle form submission via AJAX (no redirect)
    const emailForm = document.getElementById('wedding-email-form');
    if (emailForm) {
      emailForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(emailForm);
        formData.append('form-name', 'wedding-email');

        fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(formData).toString()
        })
        .then(function(response) {
          if (response.ok) {
            // Hide form, show success message
            emailForm.style.display = 'none';
            document.getElementById('form-success').style.display = 'block';
          } else {
            alert('Sorry, there was an error. Please try again.');
          }
        })
        .catch(function(error) {
          alert('Sorry, there was an error. Please try again.');
        });
      });
    }
    </script>
  </body>
</html>
